# Azure DevOps Pipeline for Azure Container Instances
# ã“ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯ Bicep ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã® CI/CD ã‚’å®Ÿç¾ã—ã¾ã™

trigger:
  branches:
    include:
    - main
    - develop
  paths:
    include:
    - templates/*
    - azure-pipelines.yml

pr:
  branches:
    include:
    - main
  paths:
    include:
    - templates/*

variables:
  # Azure ã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶šå
  azureSubscription: 'azure-service-connection'
  
  # ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã¨ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³
  resourceGroupName: 'rg-aci-$(Build.SourceBranchName)'
  location: 'Japan East'
  
  # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®š
  templateType: 'aci-simple'
  containerGroupName: 'aci-$(Build.SourceBranchName)-$(Build.BuildNumber)'

stages:
- stage: Validate
  displayName: 'ğŸ” Validate Templates'
  jobs:
  - job: ValidateBicep
    displayName: 'Bicep Template Validation'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    - task: AzureCLI@2
      displayName: 'ğŸ§ª Bicep Syntax Validation'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "ğŸ” Bicep ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
          
          # Bicep CLI ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
          az bicep version
          
          # ã‚·ãƒ³ãƒ—ãƒ« ACI ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ¤œè¨¼
          echo "ğŸ“‹ aci-simple ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ¤œè¨¼ä¸­..."
          az bicep build --file ./templates/aci-simple/main.bicep
          
          echo "âœ… ã™ã¹ã¦ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸ"
    
    - task: AzureCLI@2
      displayName: 'ğŸ”® What-If Analysis'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "ğŸ”® What-If åˆ†æã‚’å®Ÿè¡Œä¸­..."
          
          # ãƒ†ã‚¹ãƒˆç”¨ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
          TEST_RG="rg-aci-test-$(Build.BuildNumber)"
          echo "ğŸ“‚ ãƒ†ã‚¹ãƒˆç”¨ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ: $TEST_RG"
          az group create --name "$TEST_RG" --location "$(location)"
          
          # ã‚·ãƒ³ãƒ—ãƒ« ACI ã® What-If
          echo "ğŸ” aci-simple ã® What-If åˆ†æ..."
          az deployment group what-if \
            --resource-group "$TEST_RG" \
            --template-file ./templates/aci-simple/main.bicep \
            --parameters ./templates/aci-simple/main.parameters.json \
            --parameters containerGroupName="test-aci-simple"
            
          # ãƒ†ã‚¹ãƒˆç”¨ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®å‰Šé™¤
          echo "ğŸ§¹ ãƒ†ã‚¹ãƒˆç”¨ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤: $TEST_RG"
          az group delete --name "$TEST_RG" --yes --no-wait
    
    - task: PublishBuildArtifacts@1
      displayName: 'ğŸ“¦ Publish Artifacts'
      inputs:
        PathtoPublish: '$(Build.SourcesDirectory)'
        ArtifactName: 'bicep-templates'
        publishLocation: 'Container'

- stage: SecurityScan
  displayName: 'ğŸ”’ Security Scan'
  dependsOn: Validate
  jobs:
  - job: SecurityCheck
    displayName: 'Security and Quality Check'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    - task: Bash@3
      displayName: 'ğŸ›¡ï¸ Security Scan'
      inputs:
        targetType: 'inline'
        script: |
          echo "ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚’å®Ÿè¡Œä¸­..."
          
          # æ©Ÿå¯†æƒ…å ±ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒã‚§ãƒƒã‚¯
          echo "ğŸ” æ©Ÿå¯†æƒ…å ±ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          if grep -r "password\|secret\|key" ./templates/ --include="*.bicep" --include="*.json"; then
            echo "##vso[task.logissue type=error]âš ï¸ æ©Ÿå¯†æƒ…å ±ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            exit 1
          else
            echo "âœ… æ©Ÿå¯†æƒ…å ±ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi
          
          # ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã®ãƒã‚§ãƒƒã‚¯
          if grep -r "\"type\": \"Public\"" ./templates/ --include="*.bicep" --include="*.json"; then
            echo "##vso[task.logissue type=warning]âš ï¸ ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
          fi
          
          echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸ"

- stage: DeployDev
  displayName: 'ğŸš€ Deploy to Development'
  dependsOn: 
  - Validate
  - SecurityScan
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
  jobs:
  - deployment: DeployToDev
    displayName: 'Deploy to Development Environment'
    pool:
      vmImage: 'ubuntu-latest'
    environment: 'development'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: bicep-templates
          
          - task: AzureCLI@2
            displayName: 'ğŸ“‚ Create Resource Group'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                RG_NAME="$(resourceGroupName)"
                echo "ğŸ“‚ é–‹ç™ºç’°å¢ƒç”¨ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ: $RG_NAME"
                az group create --name "$RG_NAME" --location "$(location)"
          
          - task: AzureResourceManagerTemplateDeployment@3
            displayName: 'ğŸ¯ Deploy Bicep Template'
            inputs:
              deploymentScope: 'Resource Group'
              azureResourceManagerConnection: $(azureSubscription)
              subscriptionId: '$(ARM_SUBSCRIPTION_ID)'
              action: 'Create Or Update Resource Group'
              resourceGroupName: '$(resourceGroupName)'
              location: '$(location)'
              templateLocation: 'Linked artifact'
              csmFile: '$(Pipeline.Workspace)/bicep-templates/templates/$(templateType)/main.bicep'
              csmParametersFile: '$(Pipeline.Workspace)/bicep-templates/templates/$(templateType)/main.parameters.json'
              overrideParameters: '-containerGroupName $(containerGroupName) -environmentName development'
              deploymentMode: 'Incremental'
              deploymentName: 'aci-deployment-$(Build.BuildNumber)'
          
          - task: AzureCLI@2
            displayName: 'ğŸ“Š Get Deployment Results'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚’å–å¾—ä¸­..."
                
                DEPLOYMENT_NAME="aci-deployment-$(Build.BuildNumber)"
                RG_NAME="$(resourceGroupName)"
                
                # ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã®å–å¾—
                FQDN=$(az deployment group show --resource-group "$RG_NAME" --name "$DEPLOYMENT_NAME" --query properties.outputs.fqdn.value -o tsv)
                URL=$(az deployment group show --resource-group "$RG_NAME" --name "$DEPLOYMENT_NAME" --query properties.outputs.url.value -o tsv)
                
                echo "ğŸŒ FQDN: $FQDN"
                echo "ğŸ”— URL: $URL"
                
                # ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å¤‰æ•°ã«è¨­å®š
                echo "##vso[task.setvariable variable=deploymentUrl]$URL"
                echo "##vso[task.setvariable variable=deploymentFqdn]$FQDN"
          
          - task: Bash@3
            displayName: 'ğŸ§ª Test Deployment'
            inputs:
              targetType: 'inline'
              script: |
                echo "ğŸ§ª ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ†ã‚¹ãƒˆä¸­..."
                
                # ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç–é€šç¢ºèªï¼ˆæœ€å¤§5åˆ†é–“ãƒªãƒˆãƒ©ã‚¤ï¼‰
                for i in {1..30}; do
                  if curl -f "$(deploymentUrl)" > /dev/null 2>&1; then
                    echo "âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸ: $(deploymentUrl)"
                    break
                  else
                    echo "â³ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­... ($i/30)"
                    sleep 10
                  fi
                done

- stage: DeployProd
  displayName: 'ğŸ­ Deploy to Production'
  dependsOn: 
  - Validate
  - SecurityScan
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['Build.Reason'], 'Manual'))
  jobs:
  - deployment: DeployToProd
    displayName: 'Deploy to Production Environment'
    pool:
      vmImage: 'ubuntu-latest'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: bicep-templates
          
          - task: AzureCLI@2
            displayName: 'ğŸ“‚ Ensure Production Resource Group'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                PROD_RG="rg-aci-prod"
                echo "ğŸ“‚ æœ¬ç•ªç’°å¢ƒãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç¢ºèª: $PROD_RG"
                if ! az group show --name "$PROD_RG" > /dev/null 2>&1; then
                  echo "ğŸ“ æœ¬ç•ªç’°å¢ƒãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ: $PROD_RG"
                  az group create --name "$PROD_RG" --location "$(location)"
                else
                  echo "âœ… æœ¬ç•ªç’°å¢ƒãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™"
                fi
                echo "##vso[task.setvariable variable=prodResourceGroup]$PROD_RG"
          
          - task: AzureCLI@2
            displayName: 'ğŸ” Production Pre-deployment Check'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "ğŸ” æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã® What-If åˆ†æ..."
                
                az deployment group what-if \
                  --resource-group "$(prodResourceGroup)" \
                  --template-file "$(Pipeline.Workspace)/bicep-templates/templates/aci-simple/main.bicep" \
                  --parameters "$(Pipeline.Workspace)/bicep-templates/templates/aci-simple/main.parameters.json" \
                  --parameters containerGroupName="aci-prod" environmentName="production"
          
          - task: AzureResourceManagerTemplateDeployment@3
            displayName: 'ğŸš€ Deploy to Production'
            inputs:
              deploymentScope: 'Resource Group'
              azureResourceManagerConnection: $(azureSubscription)
              subscriptionId: '$(ARM_SUBSCRIPTION_ID)'
              action: 'Create Or Update Resource Group'
              resourceGroupName: '$(prodResourceGroup)'
              location: '$(location)'
              templateLocation: 'Linked artifact'
              csmFile: '$(Pipeline.Workspace)/bicep-templates/templates/aci-simple/main.bicep'
              csmParametersFile: '$(Pipeline.Workspace)/bicep-templates/templates/aci-simple/main.parameters.json'
              overrideParameters: '-containerGroupName aci-prod -environmentName production'
              deploymentMode: 'Incremental'
              deploymentName: 'aci-prod-deployment-$(Build.BuildNumber)'
          
          - task: AzureCLI@2
            displayName: 'ğŸ“Š Production Deployment Results'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "ğŸ“Š æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚’å–å¾—ä¸­..."
                
                DEPLOYMENT_NAME="aci-prod-deployment-$(Build.BuildNumber)"
                
                FQDN=$(az deployment group show --resource-group "$(prodResourceGroup)" --name "$DEPLOYMENT_NAME" --query properties.outputs.fqdn.value -o tsv)
                URL=$(az deployment group show --resource-group "$(prodResourceGroup)" --name "$DEPLOYMENT_NAME" --query properties.outputs.url.value -o tsv)
                
                echo "ğŸ­ æœ¬ç•ªç’°å¢ƒ FQDN: $FQDN"
                echo "ğŸ”— æœ¬ç•ªç’°å¢ƒ URL: $URL"

- stage: Cleanup
  displayName: 'ğŸ§¹ Cleanup Old Resources'
  dependsOn: 
  - DeployDev
  condition: and(always(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
  jobs:
  - job: CleanupOldResources
    displayName: 'Clean up old development resources'
    pool:
      vmImage: 'ubuntu-latest'
    
    steps:
    - task: AzureCLI@2
      displayName: 'ğŸ§¹ Remove Old Resource Groups'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "ğŸ§¹ 7æ—¥ä»¥ä¸Šå¤ã„é–‹ç™ºç’°å¢ƒãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ä¸­..."
          
          # 7æ—¥å‰ã®æ—¥ä»˜ã‚’è¨ˆç®—
          CUTOFF_DATE=$(date -d '7 days ago' +%Y-%m-%d)
          echo "å‰Šé™¤å¯¾è±¡æ—¥ä»˜: $CUTOFF_DATE ã‚ˆã‚Šå¤ã„ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—"
          
          # é–‹ç™ºç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ¤œç´¢ã—ã¦å‰Šé™¤
          az group list --query "[?starts_with(name, 'rg-aci-develop-')]" --output table
          
          az group list --query "[?starts_with(name, 'rg-aci-develop-')].[name]" -o tsv | while read rg_name; do
            # ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆæ—¥ã‚’å–å¾—ï¼ˆã‚¿ã‚°ã¾ãŸã¯ä½œæˆæ™‚åˆ»ã‹ã‚‰ï¼‰
            CREATION_TIME=$(az group show --name "$rg_name" --query "properties.provisioningState" -o tsv)
            
            if [[ -n "$rg_name" ]]; then
              echo "ğŸ—‘ï¸ å¤ã„ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ : $rg_name"
              az group delete --name "$rg_name" --yes --no-wait
            fi
          done
          
          echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
